# RF ê¸°ë°˜ ìì´ë¡œ í•¸ë“¤ ì…ë ¥ ë° ë²„íŠ¼ ìƒíƒœ ì†¡ìˆ˜ì‹  ì‹œìŠ¤í…œ

## ğŸ¯ í”„ë¡œì íŠ¸ í™œìš© ë°©ì•ˆ
ë³¸ í”„ë¡œì íŠ¸ëŠ” ë¬´ì„  í•¸ë“¤ì„ í†µí•´ RCì¹´ë¥¼ ì œì–´í•˜ëŠ” ì‹œìŠ¤í…œì˜ í•µì‹¬ ë°ì´í„°ì¸ **ìì´ë¡œì„¼ì„œ ê¸°ë°˜ roll ê°’**ê³¼ **ì•…ì…€(acc), ë¸Œë ˆì´í¬(brk) ë²„íŠ¼ì˜ ëˆŒë¦¼ ì‹œê°„**ì„ **NRF24L01+ RF ëª¨ë“ˆ**ì„ í†µí•´ ì†¡ìˆ˜ì‹ í•¨ìœ¼ë¡œì¨, RCì¹´ì˜ ì¡°í–¥ ë° ê°€ê°ì† ì œì–´ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤. ì†¡ì‹ ë¶€ì™€ ìˆ˜ì‹ ë¶€ ëª¨ë‘ STM32F103C8T6 MCU ê¸°ë°˜ì´ë©°, ì´í›„ ìˆ˜ì‹ ë¶€ëŠ” STM32F446RE(M4 ì½”ì–´)ë¡œ ì „í™˜í•  ì˜ˆì •ì…ë‹ˆë‹¤.

---

## ğŸ“– ì´ë¡  ê°œìš”

### ê´€ë ¨ ê¸°ìˆ  ê°œìš”

**NRF24L01+ ëª¨ë“ˆ**ì€ 2.4GHz ì£¼íŒŒìˆ˜ ëŒ€ì—­ì—ì„œ ë™ì‘í•˜ëŠ” **ë¬´ì„  ì†¡ìˆ˜ì‹ ê¸°**ë¡œ, SPI(Serial Peripheral Interface)ë¥¼ í†µí•´ MCUì™€ ì—°ê²°ë©ë‹ˆë‹¤. ì´ ëª¨ë“ˆì€ **ìµœëŒ€ 10Mbpsì˜ SPI í†µì‹  ì†ë„**ì™€ **1Mbps~2Mbpsì˜ ë¬´ì„  ì „ì†¡ë¥ **ì„ ì§€ì›í•˜ë©°, ì €ì „ë ¥ ê³ ì„±ëŠ¥ ë¬´ì„  í†µì‹ ì´ í•„ìš”í•œ IoT, RCì¹´, ì„¼ì„œ ë„¤íŠ¸ì›Œí¬ ë“±ì— ë„ë¦¬ ì‚¬ìš©ë©ë‹ˆë‹¤.

### í•µì‹¬ ë™ì‘ ì›ë¦¬

1. **SPI í†µì‹  íë¦„**  
   - MCU(Master)ê°€ SCK(í´ëŸ­), MOSI(ë°ì´í„° ì¶œë ¥), MISO(ë°ì´í„° ì…ë ¥), CSN(ìŠ¬ë ˆì´ë¸Œ ì„ íƒ) í•€ì„ í†µí•´ **NRF24L01+ ëª¨ë“ˆ(Slave)**ê³¼ **Full-duplex ë°©ì‹**ìœ¼ë¡œ í†µì‹ í•©ë‹ˆë‹¤.
   - CSN í•€ì´ LOWê°€ ë˜ë©´ ì „ì†¡ ê°œì‹œ, HIGHê°€ ë˜ë©´ ì¢…ë£Œë©ë‹ˆë‹¤.
   - ì†¡ì‹  ì‹œ CE í•€ì„ HIGHë¡œ ì„¤ì •í•´ ë°ì´í„°ë¥¼ ë¬´ì„ ìœ¼ë¡œ ì „ì†¡í•˜ê³ , ìˆ˜ì‹  ì‹œì—ëŠ” CEë¥¼ ê³„ì† HIGHë¡œ ìœ ì§€í•´ ëŒ€ê¸° ëª¨ë“œë¡œ ë‘¡ë‹ˆë‹¤.

2. **NRF24 RF í†µì‹  ì ˆì°¨**  
   - ì†¡ì‹ ë¶€ëŠ” ë¯¸ë¦¬ ì„¤ì •ëœ íŒŒì´í”„ ì£¼ì†Œì™€ ì±„ë„ì„ ê¸°ë°˜ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.
   - ìˆ˜ì‹ ë¶€ëŠ” ë™ì¼í•œ íŒŒì´í”„ ì£¼ì†Œì™€ ì±„ë„ì„ ìˆ˜ì‹  ëŒ€ê¸° ìƒíƒœë¡œ ì„¤ì •í•˜ì—¬ ì¼ì¹˜í•˜ëŠ” ë°ì´í„°ë§Œì„ ìˆ˜ì‹ í•©ë‹ˆë‹¤.
   - ë°ì´í„° ìˆ˜ì‹  ì‹œ, IRQ í•€ì„ í†µí•´ ì¸í„°ëŸ½íŠ¸ ì‹ í˜¸ë¥¼ ë°œìƒì‹œì¼œ MCUê°€ ì´ë¥¼ ê°ì§€í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
   - Auto ACK ê¸°ëŠ¥ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ìˆ˜ì‹  ì„±ê³µ ì‹œ ìë™ìœ¼ë¡œ ì†¡ì‹ ë¶€ì— ì‘ë‹µ ì‹ í˜¸ê°€ ì „ì†¡ë©ë‹ˆë‹¤.

- ì´ í”„ë¡œì íŠ¸ëŠ” **MIT ë¼ì´ì„ ìŠ¤ë¥¼ ë”°ë¥´ëŠ” [stm32_hal_nrf24_library](https://github.com/developer328/stm32_hal_nrf24_library)**ë¥¼ ì‚¬ìš©í•˜ì˜€ìœ¼ë©°, ë‹¤ìŒ 4ê°œì˜ ì£¼ìš” íŒŒì¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤:
  - `NRF24.c`
  - `NRF24.h`
  - `NRF24_conf.h`
  - `NRF24_reg_addresses.h`

---

## ğŸ”Œ í•˜ë“œì›¨ì–´ ì—°ê²°

â€» íšŒë¡œë„ ì´ë¯¸ì§€ë¥¼ ì¶”í›„ ì‚½ì… ì˜ˆì •

---

## âš™ï¸ STM32CubeMX ì„¤ì •

### ğŸ“‹ ê¸°ë³¸ ì„¤ì • ìš”ì•½

#### ğŸŒ€ SPI1 ì„¤ì •
- **Mode**: Full-Duplex Master  
- **Prescaler**: 16 â†’ ì‹¤ì œ Baud Rate: **4.5 Mbps**  
âœ… NRF24L01+ì˜ í—ˆìš© SPI ì†ë„ëŠ” ìµœëŒ€ 10Mbps

#### ğŸ“Œ GPIO í•€ ì„¤ì •

| ê¸°ëŠ¥   | í•€ ë²ˆí˜¸ | ëª¨ë“œ               | ì„¤ëª…                             |
|--------|---------|--------------------|----------------------------------|
| MISO   | PA6     | Alternate Function | SPI ìˆ˜ì‹                          |
| MOSI   | PA7     | Alternate Function | SPI ì†¡ì‹                          |
| SCK    | PA5     | Alternate Function | SPI í´ëŸ­                         |
| CSN    | PA3     | Output Push-Pull   | Maximum output speed â†’ HIGH      |
| CE     | PA4     | Output Push-Pull   | Maximum output speed â†’ HIGH      |
| IRQ    | PB3     | External Interrupt | EXTI3, Falling Edge ì¸í„°ëŸ½íŠ¸     |

- **CSN/CE í•€ì€ NRF24 ì œì–´ ì‹ í˜¸ë¡œ ì‚¬ìš©ë˜ë©°**, í†µì‹  ì•ˆì •ì„±ì„ ìœ„í•´ `Output mode`ì™€ í•¨ê»˜ **ìµœëŒ€ ì¶œë ¥ ì†ë„(High speed)**ë¡œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤. ë‚®ì€ ì†ë„ì—ì„œëŠ” SPI í´ëŸ­ íƒ€ì´ë°ì— ë¹„í•´ ë°˜ì‘ì´ ì§€ì—°ë˜ì–´ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **IRQ í•€ì€ Falling Edgeë¡œ ì„¤ì •**í•´ì•¼ NRF24L01+ ëª¨ë“ˆì´ ë‚´ë¶€ ìˆ˜ì‹  ë²„í¼ì— ë°ì´í„°ê°€ ë„ì°©í–ˆì„ ë•Œ **í•˜ê°• ì—ì§€ ì‹ í˜¸ë¡œ ì¸í„°ëŸ½íŠ¸ë¥¼ ë°œìƒ**ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. Rising ë˜ëŠ” Level Trigger ë°©ì‹ì€ NRF24ì˜ í•˜ë“œì›¨ì–´ ë™ì‘ ë°©ì‹ê³¼ ë§ì§€ ì•Šì•„ ì¸í„°ëŸ½íŠ¸ê°€ ë°œìƒí•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## ğŸ“¶ ì „ì²´ ì‹œìŠ¤í…œ ë™ì‘ íë¦„ ìš”ì•½

1. **ì†¡ì‹ ë¶€(STM32F103C8T6)**  
   - ìì´ë¡œì„¼ì„œ MPU6050ì—ì„œ roll ê°’ì„ ì½ê³ , ë²„íŠ¼ ì¸í„°ëŸ½íŠ¸ë¥¼ í†µí•´ acc, brk ëˆŒë¦¼ ì‹œê°„ì„ 20ms ì£¼ê¸°ë¡œ ëˆ„ì  ì¸¡ì •  
   - int16_t, uint16_t, uint16_t í˜•ì‹ìœ¼ë¡œ íŒ¨í‚¹ í›„ 20ms ê°„ê²©ìœ¼ë¡œ `nrf24_transmit()` í•¨ìˆ˜ë¡œ ì „ì†¡

2. **ìˆ˜ì‹ ë¶€(STM32F103C8T6)**  
   - EXTI3(PB3) ì¸í„°ëŸ½íŠ¸ë¥¼ í†µí•´ ìˆ˜ì‹  ì´ë²¤íŠ¸ ê°ì§€  
   - roll ê°’ìœ¼ë¡œ ì„œë³´ëª¨í„° ì‹¤ì‹œê°„ PWM ì œì–´, ë™ì‹œì— acc/brk, roll ê°’ì€ OLEDì— ë””ìŠ¤í”Œë ˆì´

> âš ï¸ ì‹¤ì‹œê°„ ë¬´ì„  í†µì‹ ì˜ íš¨ìœ¨ì„±ê³¼ MCU ì—°ì‚° ì˜¤ë²„í—¤ë“œë¥¼ ê³ ë ¤í•˜ì—¬, ë¶€ë™ì†Œìˆ˜ì (float) ë°ì´í„°ë¥¼ ì§ì ‘ ì†¡ì‹ í•˜ëŠ” ë°©ì‹ì€ ë°°ì œí•˜ì˜€ìŠµë‹ˆë‹¤.  
> floatì„ ë¬´ì„  ì „ì†¡í•˜ë ¤ë©´ IEEE-754 í˜•ì‹ìœ¼ë¡œ ì§ë ¬í™”í•˜ê³ , ìˆ˜ì‹  í›„ ë‹¤ì‹œ ì—­ì§ë ¬í™”(Deserialization)í•´ì•¼ í•˜ë©°, ì´ëŠ” ì•Œê³ ë¦¬ì¦˜ ë³µì¡ë„ ë° ì½”ë“œ í¬ê¸°ë¥¼ ì¦ê°€ì‹œí‚¤ê³  í†µì‹  ì˜¤ë¥˜ ê°€ëŠ¥ì„±ë„ ë†’ì…ë‹ˆë‹¤.  
> ë”°ë¼ì„œ ë³¸ í”„ë¡œì íŠ¸ì—ì„œëŠ” `float`í˜• roll ê°’ì„ ì†¡ì‹  ì „ `int16_t` íƒ€ì…ìœ¼ë¡œ 100ë°° ìŠ¤ì¼€ì¼ë§í•˜ì—¬ ì •ìˆ˜ë¡œ ë³€í™˜í•œ ë’¤ ì „ì†¡í•˜ê³ , ìˆ˜ì‹  ì‹œ ë‹¤ì‹œ ë‚˜ëˆ„ì–´ ë³µì›í•˜ëŠ” êµ¬ì¡°ë¥¼ ì±„íƒí•˜ì˜€ìŠµë‹ˆë‹¤.
---

## ğŸŸ© ìˆ˜ì‹ ë¶€ ë™ì‘ ìš”ì•½

### ğŸ”§ ì´ˆê¸°í™” ì ˆì°¨

```c
SSD1306_Init();
HAL_TIM_PWM_Start(&htim2, TIM_CHANNEL_3);
HAL_TIM_Base_Start_IT(&htim2);

nrf24_init();
nrf24_stop_listen();
nrf24_auto_ack_all(auto_ack);
nrf24_en_ack_pld(disable);
nrf24_dpl(disable);
nrf24_set_crc(no_crc, _1byte);
nrf24_tx_pwr(_0dbm);
nrf24_data_rate(_1mbps);
nrf24_set_channel(90);
nrf24_set_addr_width(5);
nrf24_pipe_pld_size(0, 32);
nrf24_open_rx_pipe(0, rx_addr);
nrf24_listen();
```

### ğŸ“¥ ìˆ˜ì‹  ë¡œì§

- EXTI3(PB3) ì¸í„°ëŸ½íŠ¸ â†’ `nrf24_data_available()` â†’ `nrf24_receive()` í˜¸ì¶œ
- ë°ì´í„° í•´ì„ êµ¬ì¡°:
  - `rx_buffer[0]`: ì‹ë³„ì
  - `rx_buffer[1~2]`: roll (int16_t)
  - `rx_buffer[3~4]`: accel_ms (uint16_t)
  - `rx_buffer[5~6]`: brake_ms (uint16_t)

```c
if (rx_buffer[0] == 1) {
    memcpy(&roll_encoded, &rx_buffer[1], sizeof(int16_t));
    received_roll = ((float)roll_encoded) / 100.0f;

    memcpy(&received_accel_ms, &rx_buffer[3], sizeof(uint16_t));
    memcpy(&received_brake_ms, &rx_buffer[5], sizeof(uint16_t));

    new_data_flag = 1;
}
```

- OLED ì¶œë ¥ ì˜ˆì‹œ:

```
Roll: 23.45
ACC:  420ms
BRK:  180ms
```

- PWM ì„œë³´ ì œì–´:

```c
float angle = received_roll + 90.0f;
uint16_t pwm = 500 + (angle / 180.0f) * 2000.0f;
__HAL_TIM_SET_COMPARE(&htim2, TIM_CHANNEL_3, pwm);
```

> ğŸ§­ `roll > 0` â†’ ì¢ŒíšŒì „  
> ğŸ§­ `roll < 0` â†’ ìš°íšŒì „

---

## âš ï¸ğŸ› ï¸ ë¬¸ì œ í•´ê²° ë° ê°œì„ /í™•ì¥

### âœ… ê°œì„  í¬ì¸íŠ¸

- `HAL_Delay()` ì œê±°, `HAL_GetTick()` ê¸°ë°˜ ì£¼ê¸° ì²˜ë¦¬ â†’ non-blocking êµ¬ì¡°
- ì¸í„°ëŸ½íŠ¸ ê¸°ë°˜ ìˆ˜ì‹  ì²˜ë¦¬ â†’ ì‹¤ì‹œê°„ ë°˜ì‘ì„±ê³¼ CPU íš¨ìœ¨ ê°œì„ 

### ğŸ’¡ í–¥í›„ ê°œì„  ì•„ì´ë””ì–´

- ìˆ˜ì‹ ë¶€ë¥¼ STM32F446RE(M4)ë¡œ ì „í™˜  
- RTC ë° ì™¸ë¶€ ì €ì¥ì¥ì¹˜(SD ì¹´ë“œ ë“±) ì—°ë™í•˜ì—¬ ì¡°í–¥ ë° ì´ë²¤íŠ¸ ë¡œê·¸ ê¸°ë¡  
- RTOS Task êµ¬ì¡°ë¡œ í™•ì¥ ê°€ëŠ¥

---

## ğŸ”— ì°¸ê³  ë§í¬

- [stm32_hal_nrf24_library (MIT License)](https://github.com/developer328/stm32_hal_nrf24_library)
