# [I2C OLED] 자이로센서 Roll 값 실시간 디스플레이

## 🎯 프로젝트 활용 방안
본 프로젝트는 RC카의 핸들 제어용 무선 컨트롤러에 자이로센서(MPU6050)를 탑재하여,
사용자의 손목 회전(Roll 각도)을 감지하고 이를 실시간으로 I2C 기반 OLED(SSD1306)에
시각적으로 표시하는 기능을 구현합니다. 이를 통해 사용자는 조향 입력의 반응을 직관적으로
확인할 수 있으며, 센서 데이터 수신 및 시스템 동작 상태를 검증할 수 있습니다.


---

## 📖 이론 개요
### Roll 각도 → 서보모터 PWM 신호 매핑 원리

자이로센서에서 측정된 Roll 각도는 -90도에서 +90도 사이의 값이며, 이 각도를 서보모터 제어에 필요한 PWM 신호로 선형적으로 변환합니다.

#### 변환 흐름:

1. **Roll 범위 조정**  
   - 센서 값: `-90.0° ~ +90.0°`  
   - 기준점 0으로 변환: `angle = roll + 90.0` → `0° ~ 180°`

2. **PWM 신호로 매핑**  
   - 서보모터 제어 범위: `330 ~ 730` (TIM2 PWM 기준)  
   - 수식:  
     \[
     pwm = 330 + \left(\frac{angle}{180.0}\right) \times 400
     \]
   - 즉, 0도일 때 330, 180도일 때 730으로 선형 증가

3. **타이머에 적용**  
   - HAL 라이브러리 함수로 PWM 출력값 반영:  
     ```c
     __HAL_TIM_SET_COMPARE(&htim2, TIM_CHANNEL_3, pwm);
     ```

#### 시각화 예시:

| Roll(°) |  PWM 값 |
|---------|-------|
| -90     |330    |
| 0       |530    |
| +90     |730    |

> 기울어진 방향에 따라 서보모터가 정비례적으로 회전하게 만들며, 직관적인 제어에 유리합니다.

---

## 💻 코드 설명: Roll → PWM 매핑

MPU6050에서 계산된 Roll 각도(`-90° ~ +90°`)를 기준으로 서보모터가 회전하도록 하기 위해, 이 각도를 TIM2의 PWM 신호 범위(`330 ~ 730`)로 선형 매핑합니다. 이후 해당 PWM 값을 비교 레지스터에 설정하여 서보모터의 듀티비를 실시간으로 변경합니다.

```c
// 자이로센서로부터 roll 각도 가져오기
float roll = MPU6050.KalmanAngleX;

// 예외 상황 대비: 센서 오차나 진동으로 인한 극단값 제거
if (roll < -90.0f) roll = -90.0f;
if (roll > 90.0f)  roll = 90.0f;

// 기준점 조정: -90 ~ +90 → 0 ~ 180 으로 변환
float angle = roll + 90.0f;

// angle(0~180)을 서보모터용 PWM 범위(330~730)로 선형 매핑
uint16_t pwm = (uint16_t)(330 + (angle / 180.0f) * 400.0f);

// 매핑된 PWM 값을 TIM2의 채널 3에 설정 (실제 서보모터 제어 신호로 출력)
__HAL_TIM_SET_COMPARE(&htim2, TIM_CHANNEL_3, pwm);
```

---

### 🔍 세부 설명

| 단계 | 설명 |
|------|------|
| **Roll 값 수신** | `MPU6050.KalmanAngleX`는 칼만 필터를 적용한 안정된 Roll 각도 값입니다. |
| **클램핑** | ±90도를 넘는 센서 노이즈를 방지하고 서보모터 과도 동작 방지 목적입니다. |
| **선형 매핑** | `roll + 90`으로 기준점을 0으로 설정한 후, 전체 180도를 기준으로 `330~730` 범위에 대응되도록 선형 변환합니다. |
| **PWM 설정** | STM32의 `__HAL_TIM_SET_COMPARE()` 함수는 TIM2 채널 3의 CCR 레지스터 값을 갱신하며, 이 값은 PWM 듀티비를 결정합니다. 

---

## 💡 향후 확장 방향

- M4 보드의 고속 클럭 기반 높은 해상도의 PWM 듀티비 매핑
- 무선 송신(NRF24L01) 연동
- FreeRTOS 기반 태스크 분리
---
