#  Broadcast κΈ°λ° CAN μ†΅/μμ‹  μ΄μνμ„Όμ„ -> ν–…ν‹±μ„Όμ„ μ μ–΄ ν†µν•© (v1.5.0)

## π“ λ™μ‘ μ”μ•½
μ„Όμ„λ¶€λ” μ΄μν μ„Όμ„λ΅ μΈ΅μ •ν• κ±°λ¦¬κ°’μ„ κΈ°λ°μΌλ΅, μ¥μ• λ¬Ό κ°μ§€ μ—¬λ¶€μ— λ”°λΌ 1 λλ” 0μ μƒνƒ λ°μ΄ν„°λ¥Ό μƒμ„±ν•κ³ , μ΄λ¥Ό CAN ID 0x6A5λ΅ λΈλ΅λ“μΊμ¤νΈ μ „μ†΅ν•λ‹¤. μ΄ λ©”μ‹μ§€λ” λ™μΌν• IDλ¥Ό μμ‹  ν•„ν„°λ΅ μ„¤μ •ν• λ¨λ“  CAN λ…Έλ“μ—μ„ λ™μ‹μ— μμ‹ λλ©°, κ° λ…Έλ“λ” μμ‹ λ λ°μ΄ν„°λ¥Ό κΈ°λ°μΌλ΅ κ³ μ ν• μ—­ν• μ„ μν–‰ν•κ² λλ‹¤.

μƒνƒλ¶€(car_status) μμ‹  λ…Έλ“λ” OLED λ””μ¤ν”λ μ΄μ— κ°μ§€ μƒνƒλ¥Ό ν…μ¤νΈλ΅ μ¶λ ¥ν•λ‹¤:

- 0 μμ‹  μ‹: "SAFE" (κ°μ§€λμ§€ μ•μ)
- 1 μμ‹  μ‹: "DETECTED" (μ¥μ• λ¬Ό κ°μ§€λ¨)

μ¤‘μ•™μ μ–΄λ¶€(car_central) μμ‹  λ…Έλ“λ” ν–…ν‹± μ„Όμ„λ¥Ό ν†µν•΄ μ§„λ™ ν”Όλ“λ°±μ„ μ κ³µν•λ©°, 1 μμ‹  μ‹μ—λ§ μ§„λ™ λ¨ν„°κ°€ μ‘λ™λλ‹¤.

μ΄μ™€ κ°™μ΄, ν•λ‚μ CAN λ©”μ‹μ§€λ¥Ό κΈ°λ°μΌλ΅ μ—¬λ¬ λ…Έλ“κ°€ κ°κΈ° λ‹¤λ¥Έ λ°©μ‹μΌλ΅ λ°μ‘ν•λ” λΈλ΅λ“μΊμ¤νΈ κΈ°λ° λ¶„μ‚° μ μ–΄ κµ¬μ΅°λ¥Ό κµ¬μ„±ν•λ‹¤.

### Broadcast λ°©μ‹μ΄λ€?
CAN ν†µμ‹ μ—μ„ ν•λ‚μ μ†΅μ‹  λ…Έλ“κ°€ νΉμ • IDλ΅ μ „μ†΅ν• λ©”μ‹μ§€λ¥Ό λ‹¤μμ μμ‹  λ…Έλ“κ°€ λ™μ‹μ— μμ‹ ν•λ” κµ¬μ΅°λ¥Ό λΈλ΅λ“μΊμ¤νΈ(Broadcast) λ°©μ‹μ΄λΌκ³  ν•λ‹¤. μ΄λ” CANμ λ©”μ‹μ§€ ID κΈ°λ° ν•„ν„°λ§ κµ¬μ΅°λ¥Ό ν™μ©ν• μ „ν•μ μΈ μ„¤κ³„λΌκ³  ν•  μ μλ‹¤.

#### μ‘λ™ λ°©μ‹

|μ†΅μ‹ λ…Έλ“|μμ‹ λ…Έλ“1|μμ‹ λ…Έλ“2|μ „μ†΅ID|ν¨κ³Ό|
|:---:|:---:|:---:|:---:|:---:|
|Sensor|Status|Central|0x6A5|λ¨λ“  λ…Έλ“κ°€ μμ‹ κ°€λ¥|

- μμ‹  λ…Έλ“λ” CAN ν•„ν„°λ¥Ό λ™μΌν• ID(0x6A5) λ΅ μ„¤μ •ν•¨μΌλ΅μ¨ λ™μΌ λ©”μ‹μ§€λ¥Ό λ™μ‹μ— μμ‹ ν•  μ μλ‹¤.
- λ©”μ‹μ§€ κµ¬μ΅°λ” κ°™λ”λΌλ„ μμ‹  λ…Έλ“μ μ—­ν• μ— λ”°λΌ ν•΄μ„ λ° μ²λ¦¬ λ°©μ‹μ΄ λ‹¬λΌμ§ μ μλ‹¤.

#### μ¥μ 
- λ™κΈ°ν™” μ μ§€: λ™μΌν• μ •λ³΄λ΅ μ—¬λ¬ μ¥μΉκ°€ λ™μ‹μ— λ°μ‘ κ°€λ¥
- ν†µμ‹  ν¨μ¨μ : λ™μΌ λ©”μ‹μ§€ 1ν μ „μ†΅μΌλ΅ λ‹¤μ λ…Έλ“ λ™μ‘ κ°€λ¥
- ν™•μ¥ μ©μ΄: μƒ λ…Έλ“ μ¶”κ°€ μ‹ ν•„ν„° μ„¤μ •λ§μΌλ΅ κ°„λ‹¨ν μ°Έμ—¬ κ°€λ¥

#### μ£Όμμ 
- λ¨λ“  μμ‹  λ…Έλ“κ°€ κ°™μ€ IDλ¥Ό λ°›κΈ° λ•λ¬Έμ—, κ° μμ‹  μΈ΅μ—μ„ μμ‹  λ°μ΄ν„°λ¥Ό μμ²΄ νλ‹¨ν•΄ μ„ νƒμ μΌλ΅ μ²λ¦¬ν•΄μ•Ό ν•¨
    - ex: RxData[0] κ°’μ΄ 1μΌ λ•λ§ λ™μ‘
- λ§μ•½ κ° λ…Έλ“κ°€ μ„λ΅ λ‹¤λ¥Έ λ°μ΄ν„°λ¥Ό μμ‹ ν•΄μ•Ό ν•λ‹¤λ©΄, μ†΅μ‹  IDλ¥Ό λ¶„λ¦¬ν•΄μ•Ό ν•¨
    - ex: 0x6A1 β†’ Slave1 μ „μ©, 0x6A2 β†’ Slave2 μ „μ©
---

## π” ν•λ“μ›¨μ–΄ μ—°κ²°

<img src="../wiring_diagram/car_Integration_v1.5.0.png" alt="μ΄μν-ν–…ν‹± can ν†µμ‹  λ°°μ„ λ„" width="1000"/>

---

## β™οΈ STM32CubeMX μ„¤μ •

### μ†΅μ‹ λ…Έλ“ ioc μ„¤μ •

- CAN
    - can > activated
    - parameter settings
        - prescaler : 72
        - time qunta bs 1 : 2times
        - time qunta bs 2 : 1times
        -> 125000 bit/s

- TIM <br> 
    `μ΄μνμ„Όμ„(μ „λ°©)`
    - Tim4_ch1 -> Input Capture direct mode 
    - TIM4 global interrupt
    - parameter settings
        - prescaler : 72-1
        - counter period : 65535(0xffff)

    `μ΄μνμ„Όμ„(ν›„λ°©)`
    - Tim4_ch2 -> Input Capture direct mode
    - TIM4 global interrupt
    - parameter settings
        - prescaler : 72-1
        - counter period : 65535(0xffff)

    `Delay ν•¨μμ© Timer μ¶”κ°€`
    - TIM2 > Mode: Internal Clock
    - parameter settings
        - prescaler : 72-1
        - counter period : 65535  
    
- GPIO
    - pb9 : can_tx
    - pb8 : can_rx
    - pb6 : Front_Echo (tim4_ch1)
    - pb7 : Rear_Echo (tim4_ch2)
    - pa9 : Front_Trig (gpio_output)
    - pa8 : Rear_Trig (gpio_output)
    - TIM2λ” delayμ©μ΄λ―€λ΅ μ•„λ¬΄ ν•€λ„ ν• λ‹Ήν•μ§€ μ•μ•„λ„ λ¨

### μμ‹ λ…Έλ“(Status) ioc μ„¤μ •

- CAN
    - can > activated
    - parameter settings
        - prescaler : 72
        - time qunta bs 1 : 2times
        - time qunta bs 2 : 1times
        -> 125000 bit/s
- NVIC
    - CAN RX1 interrupt
- I2C1
    - Fast Mode (400k)
- GPIO
    - pb9 : can_tx
    - pb8 : can_rx
    - pb7 : i2c1_sda (OLED_SDA)
    - pb6 : i2c1_scl (OLED_SCL)

 
### μμ‹ λ…Έλ“(Central) ioc μ„¤μ •

- CAN
    - can > activated
    - parameter settings
        - prescaler : 72
        - time qunta bs 1 : 2times
        - time qunta bs 2 : 1times
        -> 125000 bit/s
- NVIC
    - CAN RX1 interrupt
- GPIO
    - pb9 : can_tx
    - pb8 : can_rx
    - pb10 : Haptic_In (gpio_output)

---

## π’» μ½”λ“ μ£Όμ” λ΅μ§
### μ†΅μ‹ λ…Έλ“(Sensor)
-> distance front λλ” rearμ κ°’μ΄ 10μ΄ν•μΈ κ²½μ° CAN busμ— 1μ„ μ§€μ†μ μΌλ΅ μ†΅μ‹ 
```c
while (1)
  {
	  // 20ms μ£ΌκΈ° μ²΄ν¬
	  if (HAL_GetTick() - prev_tick >= 100)
	  {
		  prev_tick = HAL_GetTick();

		  // 1) μ „λ°© νΈλ¦¬κ±° (PA9)
		  HAL_GPIO_WritePin(FRONT_TRIG_PORT, FRONT_TRIG_PIN, GPIO_PIN_SET);
		  delay_us(10);
		  HAL_GPIO_WritePin(FRONT_TRIG_PORT, FRONT_TRIG_PIN, GPIO_PIN_RESET);

		  // 2) ν›„λ°© νΈλ¦¬κ±° (PA8)
		  HAL_GPIO_WritePin(REAR_TRIG_PORT, REAR_TRIG_PIN, GPIO_PIN_SET);
		  delay_us(10);
		  HAL_GPIO_WritePin(REAR_TRIG_PORT, REAR_TRIG_PIN, GPIO_PIN_RESET);

		  // 3) κ±°λ¦¬ μ΅°κ±΄ ν™•μΈ ν›„ CAN λ°μ΄ν„° μ„¤μ •
		  if (distance_front <= 10 || distance_rear <= 10)
			TxData[0] = 1;
		  else
			TxData[0] = 0;

		  // 4) CAN λ©”μ‹μ§€ μ „μ†΅
		  HAL_CAN_AddTxMessage(&hcan, &TxHeader, TxData, &TxMailbox);
	  }
  }
```
```c
void delay_us(uint16_t us)
{
  __HAL_TIM_SET_COUNTER(&htim2, 0);
  while (__HAL_TIM_GET_COUNTER(&htim2) < us);
}
```
```c
void HAL_TIM_IC_CaptureCallback(TIM_HandleTypeDef *htim)
{
  if (htim->Instance == TIM4)
  {
    if (htim->Channel == HAL_TIM_ACTIVE_CHANNEL_1)  // μ „λ°© Echo
    {
      if (is_first_captured_front == 0)
      {
        ic_val1_front = HAL_TIM_ReadCapturedValue(htim, TIM_CHANNEL_1);
        __HAL_TIM_SET_CAPTUREPOLARITY(htim, TIM_CHANNEL_1, TIM_INPUTCHANNELPOLARITY_FALLING);
        is_first_captured_front = 1;
      }
      else
      {
        ic_val2_front = HAL_TIM_ReadCapturedValue(htim, TIM_CHANNEL_1);
        __HAL_TIM_SET_CAPTUREPOLARITY(htim, TIM_CHANNEL_1, TIM_INPUTCHANNELPOLARITY_RISING);
        __HAL_TIM_DISABLE_IT(htim, TIM_IT_CC1);
        uint32_t diff = (ic_val2_front > ic_val1_front) ? (ic_val2_front - ic_val1_front) : (0xFFFF - ic_val1_front + ic_val2_front);
        distance_front = (diff * 0.0343f) / 2.0f;
        is_first_captured_front = 0;
        __HAL_TIM_ENABLE_IT(htim, TIM_IT_CC1);
      }
    }

    else if (htim->Channel == HAL_TIM_ACTIVE_CHANNEL_2)  // ν›„λ°© Echo
    {
      if (is_first_captured_rear == 0)
      {
        ic_val1_rear = HAL_TIM_ReadCapturedValue(htim, TIM_CHANNEL_2);
        __HAL_TIM_SET_CAPTUREPOLARITY(htim, TIM_CHANNEL_2, TIM_INPUTCHANNELPOLARITY_FALLING);
        is_first_captured_rear = 1;
      }
      else
      {
        ic_val2_rear = HAL_TIM_ReadCapturedValue(htim, TIM_CHANNEL_2);
        __HAL_TIM_SET_CAPTUREPOLARITY(htim, TIM_CHANNEL_2, TIM_INPUTCHANNELPOLARITY_RISING);
        __HAL_TIM_DISABLE_IT(htim, TIM_IT_CC2);
        uint32_t diff = (ic_val2_rear > ic_val1_rear) ? (ic_val2_rear - ic_val1_rear) : (0xFFFF - ic_val1_rear + ic_val2_rear);
        distance_rear = (diff * 0.0343f) / 2.0f;
        is_first_captured_rear = 0;
        __HAL_TIM_ENABLE_IT(htim, TIM_IT_CC2);
      }
    }
  }
}
```

### μμ‹ λ…Έλ“(Status)
-> μμ‹ λ°›μ€ λ°μ΄ν„°(1 or 0)μ— λ”°λΌ OLED λ””μ¤ν”λ μ΄
```c
// can ν•„ν„° μ„¤μ • λ° μΈν„°λ½νΈ ν™μ„±ν™” ν•¨μ
void CAN_Filter_Config(void)
{
	// Configure the filter
	sFilterConfig.FilterActivation = CAN_FILTER_ENABLE;
	sFilterConfig.FilterFIFOAssignment = CAN_FILTER_FIFO1;
	sFilterConfig.FilterMode = CAN_FILTERMODE_IDMASK;
	sFilterConfig.FilterIdHigh = 0x6A5<<5;
	sFilterConfig.FilterIdLow = 0;
	sFilterConfig.FilterMaskIdHigh = 0x7FF<<5; // SET 0 to unfilter
	sFilterConfig.FilterMaskIdLow = 0;
	sFilterConfig.FilterScale = CAN_FILTERSCALE_32BIT;

	if (HAL_CAN_ConfigFilter(&hcan, &sFilterConfig) != HAL_OK)
	        Error_Handler(); // μ‹¤ν¨ μ‹ λ¬΄ν• λ£¨ν”„ λ“± μ²λ¦¬

	// Activate the notification
	if (HAL_CAN_ActivateNotification(&hcan, CAN_IT_RX_FIFO1_MSG_PENDING) != HAL_OK)
	        Error_Handler(); // μ‹¤ν¨ μ‹ μ²λ¦¬
}
```
```c
// CAN μμ‹  μΈν„°λ½νΈ μ½λ°± ν•¨μ (FIFO1)
void HAL_CAN_RxFifo1MsgPendingCallback(CAN_HandleTypeDef *hcan)
{
    HAL_CAN_GetRxMessage(hcan, CAN_RX_FIFO1, &RxHeader, RxData);

    SSD1306_Clear();  // μ΄μ „ ν™”λ©΄ ν΄λ¦¬μ–΄

    if (RxData[0] == 1)
    {
        SSD1306_GotoXY(0, 0);
        SSD1306_Puts("Status: DETECTED", &Font_7x10, 1);
    }
    else if (RxData[0] == 0)
    {
        SSD1306_GotoXY(0, 0);
        SSD1306_Puts("Status: SAFE", &Font_7x10, 1);
    }
    else
    {
        SSD1306_GotoXY(0, 0);
        SSD1306_Puts("Status: UNKNOWN", &Font_7x10, 1);
    }

    SSD1306_UpdateScreen();  // ν™”λ©΄μ— λ°μ
}
```
### μμ‹ λ…Έλ“(Central)
-> μμ‹ λ°›μ€ λ°μ΄ν„°κ°€ 1μΈ κ²½μ° ν–…ν‹±μ„Όμ„ ON
```c
// can ν•„ν„° μ„¤μ • λ° μΈν„°λ½νΈ ν™μ„±ν™” ν•¨μ
void CAN_Filter_Config(void)
{
   // Configure the filter
   sFilterConfig.FilterActivation = CAN_FILTER_ENABLE;
   sFilterConfig.FilterFIFOAssignment = CAN_FILTER_FIFO1;
   sFilterConfig.FilterMode = CAN_FILTERMODE_IDMASK;
   sFilterConfig.FilterIdHigh = 0x6A5<<5;
   sFilterConfig.FilterIdLow = 0;
   sFilterConfig.FilterMaskIdHigh = 0x7FF<<5; // SET 0 to unfilter
   sFilterConfig.FilterMaskIdLow = 0;
   sFilterConfig.FilterScale = CAN_FILTERSCALE_32BIT;

   if (HAL_CAN_ConfigFilter(&hcan, &sFilterConfig) != HAL_OK)
           Error_Handler(); // μ‹¤ν¨ μ‹ λ¬΄ν• λ£¨ν”„ λ“± μ²λ¦¬

   // Activate the notification
   if (HAL_CAN_ActivateNotification(&hcan, CAN_IT_RX_FIFO1_MSG_PENDING) != HAL_OK)
           Error_Handler(); // μ‹¤ν¨ μ‹ μ²λ¦¬
}
```
```c
// CAN μμ‹  μΈν„°λ½νΈ μ½λ°± ν•¨μ (FIFO1)
void HAL_CAN_RxFifo1MsgPendingCallback(CAN_HandleTypeDef *hcan)
{
  HAL_CAN_GetRxMessage(hcan, CAN_RX_FIFO1, &RxHeader, RxData);

  // 1. ν–…ν‹± λ¨ν„°λ” μ¦‰μ‹ μ μ–΄
  if (RxData[0] == 1)
    HAL_GPIO_WritePin(GPIOB, GPIO_PIN_10, GPIO_PIN_SET);
  else
    HAL_GPIO_WritePin(GPIOB, GPIO_PIN_10, GPIO_PIN_RESET);
}
```
---
## π› οΈ λ¬Έμ  λ° κ°μ„ 

### λ¬Έμ 
ν„μ¬ μ†΅μ‹ λ¶€(Sensor)μ—μ„ CAN λ©”μ„Έμ§€ μ†΅μ‹  κ°„ HAL_CAN_AddTxMessage()λ¥Ό μ‚¬μ©ν•μ—¬ ν΄λ§ λ°©μ‹μΌλ΅ μ†΅μ‹  μ²λ¦¬ μ¤‘μ΄λ©° λ‹¤μμ λ‹¨μ μ΄ μ΅΄μ¬ν•¨ :
-  HAL_CAN_AddTxMessage() νΈμ¶ μ‹λ§λ‹¤ μ¦‰μ‹ μ†΅μ‹  μ”μ²­ β†’ Mailboxκ°€ κ°€λ“ μ°Όμ„ κ²½μ° μ „μ†΅ μ‹¤ν¨ κ°€λ¥μ„± μ΅΄μ¬
- λ©”μ‹μ§€λ¥Ό μ „μ†΅ν•  μ μμ„ λ•κΉμ§€ κ³„μ†ν•΄μ„ μ¬μ‹λ„ν•΄μ•Ό ν•  μλ„ μμ (Tx μ‹¤ν¨ μ²λ¦¬λ¥Ό λ³„λ„λ΅ κµ¬ν„ν•΄μ•Ό ν•¨)
- μ „μ†΅ μ‹μ μ— CPU μ μ κ°€ λ°μƒν•λ―€λ΅ μ‹¤μ‹κ°„μ„± μ‘μ—…μ΄ λ§μ•„μ§ κ²½μ° ν¨μ¨μ΄ λ–¨μ–΄μ§ μ μμ
- ν–¥ν›„ μ—¬λ¬ λ©”μ‹μ§€λ¥Ό μ†΅μ‹ ν•κ±°λ‚, λ‹¤μ¤‘ CAN λ…Έλ“ κ°„ ν†µμ‹  λΉλ„κ°€ λ†’μ•„μ§ κ²½μ° κµ¬μ΅°κ°€ λΉ„ν¨μ¨μ μΌ μ μμ

### κ°μ„ λ°©ν–¥

-  HAL_CAN_ActivateNotification() ν•¨μλ¥Ό ν†µν•΄ TX Mailbox Empty μΈν„°λ½νΈ(CAN_IT_TX_MAILBOX_EMPTY) ν™μ„±ν™”
- HAL_CAN_TxMailboxXCompleteCallback() (X=0,1,2) λλ” HAL_CAN_TxMailbox0CompleteCallback()μ—μ„ μ†΅μ‹  μ™„λ£ μ‹μ  ν™•μΈ
- μ „μ†΅ ν λλ” μƒνƒ ν”λκ·Έλ¥Ό ν†µν•΄ λ‹¤μ λ©”μ‹μ§€λ¥Ό κ΄€λ¦¬ν•μ—¬ λΉ„λ™κΈ° μ†΅μ‹  μ²λ¦¬ κµ¬μ΅°λ΅ μ „ν™

### μ΄μ 
 -  CPU μμ› ν¨μ¨ν™”
  	- μ†΅μ‹  κ°€λ¥ μƒνƒμΌ λ•λ§ μΈν„°λ½νΈκ°€ λ°μƒν•λ―€λ΅ λ©”μΈ λ£¨ν”„λ” λ‹¤λ¥Έ μ‘μ—… μν–‰ κ°€λ¥
- μ†΅μ‹  μ„±κ³µ/μ‹¤ν¨ μ¶”μ  μ©μ΄
 	- μ½λ°± κΈ°λ°μΌλ΅ Tx μ™„λ£ μ—¬λ¶€λ¥Ό λ…ν™•ν ν™•μΈ κ°€λ¥
- λ‹¤μ¤‘ λ©”μ‹μ§€ μ²λ¦¬ μ λ¦¬
 	- Tx ν κµ¬μ΅°λ΅ ν™•μ¥ κ°€λ¥ β†’ λ‹¤μ¤‘ CAN λ©”μ‹μ§€ μ†΅μ‹  μ‹ λ³‘λ© λ°©μ§€
- RTOS μ—°κ³„ μ©μ΄
 	- FreeRTOS ν™κ²½μ—μ„ μ†΅μ‹  νƒμ¤ν¬ λλ” ν κµ¬μ΅°λ΅ μ‰½κ² ν†µν•© κ°€λ¥
- ν™•μ¥μ„± ν™•λ³΄
 	- μ°¨λ‰μ© CAN ν™κ²½μ—μ„μ λ‹¤μ λ…Έλ“ ν†µμ‹ , μ£Όν–‰ μ μ–΄ μ‹μ¤ν…κ³Ό ν†µν•© μ‹ μ λ¦¬
---

## π’΅ ν–¥ν›„ ν™•μ¥ λ° κ°μ„  μ•„μ΄λ””μ–΄
- FreeRTOS κΈ°λ° CAN ν†µμ‹  λ¨λ“ν™” λ° νƒμ¤ν¬ λ¶„λ¦¬
- κ³ μ†CAN ν†µμ‹ μ„ μ„ν•΄ buad rate 500kλ΅ μƒν–¥
- CAN_IT_TX_MAILBOX_EMPTY μΈν„°λ½νΈ ν™μ„±ν™” λ° κ΄€λ ¨ μ½λ°± ν•¨μ κµ¬ν„
- μ†΅μ‹  ν κµ¬μ΅° λ„μ… μ—¬λ¶€ κ²€ν†  λ° ν™•μ¥μ„± μλ” μ†΅μ‹  κ΄€λ¦¬ κµ¬μ΅° μ„¤κ³„
- μ „μ†΅ μ™„λ£ μ΄ν›„ μƒνƒλ¥Ό OLED λ“±μΌλ΅ μ¶λ ¥ν•μ—¬ ν†µμ‹  ν™•μΈ ν”Όλ“λ°± κµ¬ν„ 
