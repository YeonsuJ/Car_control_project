#  코드 리팩토링 및 전/후진 기능, 모터 RPM 측정 로직 추가 (v1.1.0)

## 🛠️ 개선 및 기능 추가
- 핸들에 Locker 스위치를 추가하여, 스위치 토글 방향에 따라 차량 DC 모터의 회전 방향을 제어함으로써 전/후진 기능을 구현
- 이전에 구현한 DC 모터의 Timer Encoder 모드를 활용하여 모터 RPM을 측정 및 계산하는 로직을 추가
- v1.0.0의 코드를 로직별로 함수화하고 전반적인 구조를 리팩토링하여 가독성과 유지보수성을 향상

---

## 🔌 하드웨어 연결

### 송신부(Rx)
<img src="../wiring_diagram/central_v1.1.0.png" alt="Locker, Encoder RPM 측정 추가 배선도" width="500"/>

※ 수신부(Rx)는 [V1.0.0_RF_MotorCtrl.md](./V1.0.0_RF_MotorCtrl.md)와 동일

---

## ⚙️ STM32CubeMX 설정

### 송신부 변경 사항
- Motor_Forward 
    - PB8 : GPIO_Input (Pull-Up)
- Motor_Backward 
    - PB9 : GPIO_Input (Pull-Up)


### 수신부 변경사항

DC모터 Encoder
- combined channels > encoder mode
- pb6 (tim4_ch1) : encoderA
- pb7 (tim4_ch2) : encoderB
- encoder mode TI1 adn TI2
- prescaler : 0
- Counter period(ARR) : 65535 or 0xFFFF (엔코더 overflow 방지)
- Counter Mode : UP
- IC1 Polarity: Rising Edge
- IC1 Selection: Direct TI
- IC1 Prescaler: No division (1번마다 1번 인식 = 모든 엣지를 다 인식함)
- IC1 Filter: 10 (노이즈가 심하면 값을 올려줘야함)
- (IC2 항목도 동일하게 설정)

> 참고 [V1.0.0_RF_MotorCtrl.md](./V1.0.0_RF_MotorCtrl.md)
---

## 💻 동작 코드
다음은 기존의 v1.0.0 버전의 코드를 리팩토링한 사항을 요약한 것이다.

### 송신부(Tx)
#### 1. RF 송신 초기화 코드를 main에서 분리하여 NRF24_Tx_Init() 함수로 별도 정의
-> 유지보수/디버깅 시 어느 부분에서 문제가 발생했는지 빠르게 파악 가능
-> 향후 FreeRTOS Task화 또는 모듈별 재사용이 쉬움.

#### 2. NRF24 송신 데이터의 각 필드를 바이트 오프셋 기준으로 주석화
-> 통신 구조의 명확성을 높여 수신 파싱, 디버깅, 유지보수 및 확장에 용이.

```c
/* USER CODE BEGIN 0 */
// =============================
// NRF24 송신 패킷 구조 정의
// -----------------------------
// Byte 0   : 메시지 식별자 (1)
// Byte 1~2 : roll (int16_t, 센서 측에서 ×100 배율 인코딩)
// Byte 3~4 : accel_ms (uint16_t, 엑셀 유지 시간)
// Byte 5~6 : brake_ms (uint16_t, 브레이크 유지 시간)
// Byte 7   : direction (0: BACKWARD, 1: FORWARD)
// 나머지 Byte 8~31 : 예약 or 미사용
// =============================
/* USER CODE END 0 */
```
#### 3. 기타
- 방향 값을 `typedef enum { LOCKER_FORWARD, LOCKER_BACKWARD }`로 정의<br>
-> 의미를 명확히 하고, 값 사용 실수를 방지하며 향후 확장에도 유리함.
- `MPU6050_Init()` 실패 시 `Error_Handler()`를 호출하도록 수정<br>
-> 오류 발생 시 명확한 처리가 가능해졌고, 기존 코드처럼 무한 루프에 빠지는 문제를 방지함.
- 사용하지 않는 변수나 OLED 디버깅 코드 등을 정리/제거함으로써 코드의 불필요한 노이즈를 줄이고 가독성을 높임


### 수신부(Rx)
#### 1. Encoder 기반 RPM 측정 로직 추가
- 목적: DC 모터의 회전 속도를 실시간으로 측정하여 디버깅 및 제어 정확도 향상.
- 핵심 구현
    - TIM4 Encoder 모드를 이용하여 카운터 변화량 추적.
    - `Update_Motor_RPM()` 함수 내에서 100ms 주기로 엔코더 카운터 차이를 기반으로 RPM 계산.
    - `fabsf(((float)delta / TICKS_PER_REV) * 10 * 60)` 공식 사용.
    - OLED에 실시간 RPM 표시: `OLED_Display_Status()` 함수에서 `"RPM: %.1f"` 형태로 시각화. (향후 Car_status에서 구현)

#### 2. 핸들 스위치 토글 기반 전/후진 변속 로직 추가
- 목적: 핸들 스위치의 상태(RF 송신 데이터 포함)를 통해 실시간 전/후진 방향 제어.
- 핵심 구현
    - RF 패킷 내 `Byte 7`에 `direction` 값을 포함시켜 수신.
    - `typedef enum { DIRECTION_BACKWARD, DIRECTION_FORWARD } MotorDirection` 열거형 도입.
    - `motor_direction` 전역 변수로 방향 상태 유지.
    - `Update_Motor_Direction()` 함수에서 이전 방향과 비교해 GPIO IN1/IN2 제어 핀 변경.
    - 매크로 `MOTOR_FORWARD()`, `MOTOR_BACKWARD()`로 코드 가독성 및 재사용성 향상.

#### 3. 전체 코드 구조 및 유지보수성 개선
- main()에 혼재돼 있던 로직을 Control_, Update_, Parse_, OLED_ 등의 함수로 분리하여 가독성과 유지보수성 향상
- #define과 enum, 매크로를 활용 <br>(모터 방향 제어는 MOTOR_FORWARD(), MOTOR_BACKWARD() 매크로와 MotorDirection enum을 사용해 일관되게 처리)
- 구조적 리팩토링을 통해 가독성, 유지보수성, 확장성 강화

### 📺 동작 영상
[[v1.1.0] Locker 스위치 기반 전/후진기능 테스트 (with. Encoder 측정 기반 모터 RPM 계산)](https://youtu.be/5e-OUwY9L_8?si=FzceLrIsgnQ42Fs2)

---

## 💡 향후 확장 및 개선 아이디어
- 장애물을 초음파 센서로 감지 -> RF 통신을 통해 핸들로 전송, 핸들의 햅틱 센서로 운전자에게 진동 경고를 제공 
- (파이프라인 추가해 Rx와 Tx 역할을 교체하여 양방향 통신을 구현)
